<div class="dashboard-container">
  <header class="dashboard-header">
    <div class="header-content">
      <div class="logo-section">
        <img src="assets/estonantzin.jpeg" alt="Logo Estudiantina" class="logo">
        <h4>Estudiantina Tonantzin Guadalupe</h4>
      </div>
      <div class="user-info">
        <span>Bienvenid@, {{ userProfile?.name || user?.email }}</span>
        <button class="logout-btn" (click)="logout()">Cerrar Sesión</button>
      </div>
    </div>
  </header>

  <main class="dashboard-main">
    <!-- Acciones -->
    <div class="actions">
      <button class="action" routerLink="/attendance-tracking">
        <span class="action-icon">📊</span>
        <span class="action-text">Mi asistencia</span>
      </button>
      
      <button class="action" routerLink="/admin" *ngIf="isAdmin">
        <span class="action-icon">⚙️</span>
        <span class="action-text">Usuarios</span>
      </button>
      
      <button class="action" routerLink="/attendance" *ngIf="canManageAttendance">
        <span class="action-icon">✓</span>
        <span class="action-text">Asistencia</span>
      </button>
      
      <button class="action" routerLink="/attendance-summary" *ngIf="canManageAttendance">
        <span class="action-icon">📋</span>
        <span class="action-text">Resumen</span>
      </button>
      
      <button class="action" routerLink="/event-management" *ngIf="canManageEvents">
        <span class="action-icon">🎉</span>
        <span class="action-text">Eventos</span>
      </button>
      
      <button class="action" routerLink="/transport-management" *ngIf="canManageTransport">
        <span class="action-icon">🚌</span>
        <span class="action-text">Transporte</span>
      </button>
      
      <button class="action" routerLink="/ticket-sales" *ngIf="canManageTickets">
        <span class="action-icon">🎫</span>
        <span class="action-text">Boletos</span>
      </button>
      
      <button class="action" routerLink="/financial-management" *ngIf="canManageTickets">
        <span class="action-icon">🏦</span>
        <span class="action-text">Finanzas</span>
      </button>
    </div>

    <!-- Mi Tarjeta Bancaria -->
    <div class="user-card-section" *ngIf="userAccount">
      <h3>💳 Mi Tarjeta</h3>
      <div class="user-card">
        <div class="card-design">
          <div class="card-header">
            <div class="card-brand">
              <span class="card-type">ESTUDIANTINA</span>
              <span class="card-subtitle">TONANTZIN GUADALUPE</span>
            </div>
            <div class="card-label">
              <span class="card-text">CARD</span>
            </div>
          </div>
          
          <div class="card-number">
            {{ userAccount.cardNumber | slice:0:4 }} {{ userAccount.cardNumber | slice:4:8 }} {{ userAccount.cardNumber | slice:8:12 }} {{ userAccount.cardNumber | slice:-4 }}
          </div>
          
          <div class="card-info">
            <div class="account-holder">
              <span class="label">TITULAR</span>
              <span class="value">{{ userAccount.userName }}</span>
            </div>
            <div class="account-number">
              <span class="label">CUENTA</span>
              <span class="value">{{ userAccount.accountNumber }}</span>
            </div>
          </div>
          
          <div class="card-balance">
            <span class="balance-label">SALDO DISPONIBLE</span>
            <span class="balance-amount">${{ userAccount.balance.toFixed(2) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Agenda de Eventos -->
    <div class="events-agenda">
      <h3>Próximos Eventos</h3>
      <div class="events-list" *ngIf="activeEvents.length > 0">
        <div class="event-item" *ngFor="let event of activeEvents">
          <div class="event-main-info">
            <div class="event-header">
              <h4 class="event-title">{{ event.title }}</h4>
              <div class="event-badges">
                <span class="type-badge" [class]="event.type">{{ getTypeText(event.type) }}</span>
                <span class="attire-badge" [class]="event.attire">{{ getAttireText(event.attire) }}</span>
              </div>
            </div>
            
            <div class="event-details">
              <div class="event-date">
                <span class="date-icon">📅</span>
                <span>{{ event.date }}</span>
              </div>
              <div class="event-location" *ngIf="event.location">
                <span class="location-icon">📍</span>
                <span>{{ event.location }}</span>
              </div>
              <div class="event-times" *ngIf="event.meetingTime || event.startTime">
                <span class="time-icon">🕰️</span>
                <span *ngIf="event.meetingTime">Reunión: {{ event.meetingTime }}</span>
                <span *ngIf="event.startTime"> | Inicio: {{ event.startTime }}</span>
              </div>
            </div>
          </div>
          
          <div class="event-confirmation">
            <div class="confirmation-status">
              <span class="confirmation-label">Tu confirmación:</span>
              <span class="confirmation-badge" [class]="getConfirmationClass(event.userConfirmation)">
                {{ getConfirmationText(event.userConfirmation) }}
              </span>
            </div>
            <div class="companions-info" *ngIf="event.requiresTransport && event.userConfirmation?.companions !== undefined && event.userConfirmation?.companions !== null">
              <span class="companions-text">🚌 {{ event.userConfirmation?.companions || 0 }} acompañantes</span>
            </div>
            <div class="total-people-info" *ngIf="event.requiresTransport">
              <span class="total-people-text">👥 {{ getTotalPeopleForEvent(event) }} personas total</span>
            </div>
            
            <div class="transport-info" *ngIf="event.requiresTransport && hasTransportConfig(event.id)">
              <button class="transport-btn" (click)="viewTransportMap(event.id)">
                🗺️ Ver Mapa de Asientos
              </button>
              <div class="payment-status-info">
                <div class="payment-status" [class]="getPaymentStatusClass(getPaymentStatusForEvent(event.id).status)">
                  <span class="payment-label">Estado de Pago:</span>
                  <span class="payment-text">{{ getPaymentStatusText(getPaymentStatusForEvent(event.id).status) }}</span>
                </div>
                <div class="payment-amounts" *ngIf="getPaymentStatusForEvent(event.id).total > 0">
                  <span class="payment-amount">Total: ${{ getPaymentStatusForEvent(event.id).total }}</span>
                  <span class="payment-paid" *ngIf="getPaymentStatusForEvent(event.id).paid > 0">Pagado: ${{ getPaymentStatusForEvent(event.id).paid }}</span>
                </div>
              </div>
              <div class="cost-info" *ngIf="getTransportCost(event.id) > 0 && getPaymentStatusForEvent(event.id).status === 'sin-boletos'">
                <span class="cost-text">💰 ${{ getUnitCost(event.id) }} por persona (estimado)</span>
              </div>
            </div>
            <button class="view-event-btn" (click)="viewEventDetails(event.id)">
              Ver Detalles
            </button>
          </div>
        </div>
      </div>
      
      <div class="no-events" *ngIf="activeEvents.length === 0">
        <p>No hay eventos próximos</p>
      </div>
    </div>

    <div class="attendance-chart" (click)="goToTracking()">
      <h3>Mi Asistencia</h3>
      <div class="charts-container">
        <div class="donut-chart">
          <svg width="150" height="150" viewBox="0 0 150 150">
            <circle cx="75" cy="75" r="60" fill="none" stroke="#e1e5e9" stroke-width="15" *ngIf="attendancePercentage < 100"></circle>
            <circle 
              cx="75" 
              cy="75" 
              r="60" 
              fill="none" 
              stroke="#189d98" 
              stroke-width="15"
              [attr.stroke-dasharray]="attendancePercentage === 100 ? '377' : (attendancePercentage * 377) / 100 + ' 377'"
              [attr.stroke-dashoffset]="attendancePercentage === 100 ? '0' : '94.25'"
              [attr.transform]="attendancePercentage === 100 ? '' : 'rotate(-90 75 75)'">
            </circle>
          </svg>
          <div class="chart-center">
            <span class="percentage">{{ attendancePercentage }}%</span>
            <span class="label">Efectiva</span>
          </div>
        </div>
        
        <div class="donut-chart">
          <svg width="150" height="150" viewBox="0 0 150 150">
            <circle cx="75" cy="75" r="60" fill="none" stroke="#e1e5e9" stroke-width="15" *ngIf="participationPercentage < 100"></circle>
            <circle 
              cx="75" 
              cy="75" 
              r="60" 
              fill="none" 
              stroke="#189d98" 
              stroke-width="15"
              [attr.stroke-dasharray]="participationPercentage === 100 ? '377' : (participationPercentage * 377) / 100 + ' 377'"
              [attr.stroke-dashoffset]="participationPercentage === 100 ? '0' : '94.25'"
              [attr.transform]="participationPercentage === 100 ? '' : 'rotate(-90 75 75)'">
            </circle>
          </svg>
          <div class="chart-center">
            <span class="percentage">{{ participationPercentage }}%</span>
            <span class="label">Asistencia</span>
          </div>
        </div>
      </div>
      
      <div class="attendance-summary">
        <h4>Resumen de Asistencia</h4>
        <div class="summary-list">
          <div class="summary-item">
            <span class="summary-icon">✅</span>
            <span class="summary-label">Presente</span>
            <div class="summary-count">
              <span class="count-fraction">{{ attendanceStats.presente }} de {{ totalAttendances }}</span>
              <span class="count-percentage">({{ getPercentage(attendanceStats.presente) }}%)</span>
            </div>
          </div>
          <div class="summary-item">
            <span class="summary-icon">🏫</span>
            <span class="summary-label">Escuela</span>
            <div class="summary-count">
              <span class="count-fraction">{{ attendanceStats.escuela }} de {{ totalAttendances }}</span>
              <span class="count-percentage">({{ getPercentage(attendanceStats.escuela) }}%)</span>
            </div>
          </div>
          <div class="summary-item">
            <span class="summary-icon">🩺</span>
            <span class="summary-label">Enfermedad</span>
            <div class="summary-count">
              <span class="count-fraction">{{ attendanceStats.enfermedad }} de {{ totalAttendances }}</span>
              <span class="count-percentage">({{ getPercentage(attendanceStats.enfermedad) }}%)</span>
            </div>
          </div>
          <div class="summary-item">
            <span class="summary-icon">❌</span>
            <span class="summary-label">Falta</span>
            <div class="summary-count">
              <span class="count-fraction">{{ attendanceStats.falta }} de {{ totalAttendances }}</span>
              <span class="count-percentage">({{ getPercentage(attendanceStats.falta) }}%)</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="misa-chart" (click)="goToTracking()">
      <h3>Misa Dominical</h3>
      <div class="misa-donut">
        <svg width="200" height="200" viewBox="0 0 200 200">
          <circle 
            cx="100" 
            cy="100" 
            r="80" 
            fill="none" 
            stroke="#ffd700" 
            stroke-width="20">
          </circle>
        </svg>
        <div class="chart-center">
          <span class="percentage">{{ misaStats.percentage }}%</span>
          <span class="label">Asistencia</span>
        </div>
      </div>
      <div class="misa-stats">
        <div class="misa-stat">
          <span class="stat-number">{{ misaStats.asistidas }}</span>
          <span class="stat-label">Asistidas</span>
        </div>
        <div class="misa-stat">
          <span class="stat-number">{{ misaStats.faltas }}</span>
          <span class="stat-label">Faltas</span>
        </div>
        <div class="misa-stat">
          <span class="stat-number">{{ misaStats.total }}</span>
          <span class="stat-label">Total</span>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Modal de Mapa de Asientos -->
  <div class="transport-modal" *ngIf="showTransportModal" (click)="closeTransportModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>🗺️ Mapa de Asientos del Transporte</h3>
        <button class="close-btn" (click)="closeTransportModal()">✕</button>
      </div>
      
      <div class="modal-body">

        
        <div class="my-transport-info">
          <h4>👤 Mi Información de Transporte</h4>
          <div class="my-seats" *ngIf="getMySeats().length > 0">
            <div class="seat-info" *ngFor="let seatInfo of getMySeats()">
              <div class="seat-details">
                <span class="passenger-name">{{ seatInfo.passengerName }}</span>
                <span class="seat-location">Vehículo {{ seatInfo.vehicleIndex + 1 }} - Asiento {{ seatInfo.seatIndex + 1 }}</span>
                <span class="passenger-type">{{ seatInfo.isCompanion ? 'Acompañante' : 'Integrante' }}</span>
              </div>
              <div class="cost-info">
                <span class="individual-cost">${{ getUnitCostFromConfig() }}</span>
              </div>
            </div>
            <div class="total-cost">
              <span class="total-label">Total a pagar:</span>
              <span class="total-amount">${{ getMyTotalCost() }}</span>
            </div>
          </div>
          <div class="no-seats" *ngIf="getMySeats().length === 0">
            <p>Aún no tienes asientos asignados</p>
          </div>
        </div>
        
        <div class="vehicles-section">
          <h4>Distribución de Asientos</h4>
          <div class="vehicles-grid">
            <div class="vehicle-card" *ngFor="let vehicle of selectedTransportConfig?.vehicles; let i = index">
              <div class="vehicle-header">
                <h5>🚐 Vehículo {{ i + 1 }}</h5>
                <div class="vehicle-info">
                  <span class="occupancy">{{ vehicle.occupiedSeats }}/{{ vehicle.totalSeats }}</span>
                  <span class="vehicle-cost" *ngIf="vehicle.vehicleCost > 0">${{ vehicle.vehicleCost }}</span>
                </div>
              </div>
              
              <div class="vehicle-pricing" *ngIf="vehicle.vehicleCost > 0 && vehicle.occupiedSeats > 0">
                <span class="price-per-seat">💰 ${{ (vehicle.vehicleCost / vehicle.occupiedSeats).toFixed(2) }} por asiento</span>
              </div>
              
              <div class="vehicle-schedule-info" *ngIf="vehicle.boardingTime || vehicle.departureTime">
                <div class="schedule-info" *ngIf="vehicle.boardingTime">
                  <span class="schedule-icon">🕰️</span>
                  <span class="schedule-text">Abordaje: {{ vehicle.boardingTime }}</span>
                </div>
                <div class="schedule-info" *ngIf="vehicle.departureTime">
                  <span class="schedule-icon">🚀</span>
                  <span class="schedule-text">Salida: {{ vehicle.departureTime }}</span>
                </div>
              </div>
              <div class="seats-grid">
                <div 
                  class="seat" 
                  *ngFor="let seat of vehicle.seats; let j = index"
                  [class.occupied]="seat.occupied"
                  [class.my-seat]="isMyseat(seat)">
                  <span *ngIf="seat.occupied" class="seat-label">{{ seat.passengerName }}</span>
                  <span *ngIf="!seat.occupied" class="seat-number">{{ j + 1 }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="close-btn-footer" (click)="closeTransportModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>