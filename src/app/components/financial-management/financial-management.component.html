<div class="financial-container">
  <header class="financial-header" style="background: linear-gradient(135deg, #189d98 0%, #0f6b68 100%); color: white; padding: 1rem 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
    <div class="header-content">
      <div class="logo-section">
        <img src="assets/estonantzin.jpeg" alt="Logo Estudiantina" class="logo">
        <h4>Estudiantina Tonantzin Guadalupe</h4>
      </div>
      <div class="user-info">
        <button class="back-btn" (click)="goBack()">
          ‚Üê Dashboard
        </button>
      </div>
    </div>
  </header>

  <main class="financial-main">
    <div class="page-title">
      <h2>üè¶ Gesti√≥n Financiera</h2>
      <p>Sistema bancario para integrantes</p>
    </div>

    <!-- Usuarios sin cuenta -->
    <div class="users-without-account" *ngIf="getUsersWithoutAccount().length > 0">
      <h3>üë• Crear Cuentas</h3>
      <div class="users-grid">
        <div class="user-card" *ngFor="let user of getUsersWithoutAccount()">
          <div class="user-info">
            <span class="user-name">{{ user.name }}</span>
            <span class="user-email">{{ user.email }}</span>
          </div>
          <button class="create-account-btn" (click)="createAccount(user.id)">
            ‚ûï Crear Cuenta
          </button>
        </div>
      </div>
    </div>

    <!-- Cuentas existentes -->
    <div class="accounts-section">
      <div class="accounts-header">
        <h3>üí≥ Cuentas Activas</h3>
        <div class="search-container">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input 
              type="text" 
              placeholder="Buscar por nombre del titular..." 
              [(ngModel)]="searchTerm"
              (input)="onSearchChange()"
              class="search-input">
            <button 
              *ngIf="searchTerm" 
              class="clear-search"
              (click)="searchTerm = ''; onSearchChange()">
              ‚úï
            </button>
          </div>
        </div>
      </div>
      
      <div class="accounts-grid">
        <div class="account-card" *ngFor="let account of filteredAccounts">
          <div class="user-card">
            <div class="card-design clickable-card" (click)="viewCardMovements(account)">
              <div class="card-header">
                <div class="card-brand">
                  <span class="card-type">ESTUDIANTINA</span>
                  <span class="card-subtitle">TONANTZIN GUADALUPE</span>
                </div>
                <div class="card-label">
                  <span class="card-text">CARD</span>
                </div>
              </div>
              
              <div class="card-number">
                {{ account.cardNumber | slice:0:4 }} {{ account.cardNumber | slice:4:8 }} {{ account.cardNumber | slice:8:12 }} {{ account.cardNumber | slice:-4 }}
              </div>
              
              <div class="card-info">
                <div class="account-holder">
                  <span class="label">TITULAR</span>
                  <span class="value">{{ account.userName }}</span>
                </div>
                <div class="account-number">
                  <span class="label">CUENTA</span>
                  <span class="value">{{ account.accountNumber }}</span>
                </div>
              </div>
              
              <div class="card-balance">
                <span class="balance-label">SALDO DISPONIBLE</span>
                <span class="balance-amount">${{ account.balance.toFixed(2) }}</span>
              </div>
              
              <div class="click-hint">
                <small>üí≥ Clic para ver movimientos</small>
              </div>
            </div>
          </div>
          
          <div class="card-actions">
            <button class="action-btn deposit" (click)="openTransactionModal(account, 'deposit'); $event.stopPropagation()">
              üí∞ Depositar
            </button>
            <button class="action-btn withdraw" (click)="openTransactionModal(account, 'withdrawal'); $event.stopPropagation()">
              üí∏ Retirar
            </button>
          </div>
        </div>
      </div>
      
      <div class="no-accounts" *ngIf="filteredAccounts.length === 0 && accounts.length > 0">
        <div class="empty-state">
          <div class="empty-icon">üîç</div>
          <h3>No se encontraron cuentas</h3>
          <p>No hay cuentas que coincidan con tu b√∫squeda</p>
        </div>
      </div>
      
      <div class="no-accounts" *ngIf="accounts.length === 0">
        <div class="empty-state">
          <div class="empty-icon">üí≥</div>
          <h3>No hay cuentas creadas</h3>
          <p>Crea cuentas para los integrantes para comenzar</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de Transacci√≥n -->
  <div class="transaction-modal" *ngIf="showTransactionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>{{ transactionType === 'deposit' ? 'üí∞ Realizar Dep√≥sito' : 'üí∏ Realizar Retiro' }}</h3>
        <button class="close-btn" (click)="closeTransactionModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="account-info">
          <h4>{{ selectedAccount?.userName }}</h4>
          <p>Cuenta: {{ selectedAccount?.accountNumber }}</p>
          <p>Saldo actual: ${{ selectedAccount?.balance.toFixed(2) }}</p>
        </div>
        
        <div class="transaction-form">
          <div class="form-group">
            <label for="amount">Monto:</label>
            <input 
              type="number" 
              id="amount" 
              [(ngModel)]="transactionAmount" 
              min="0.01" 
              step="0.01"
              [max]="transactionType === 'withdrawal' ? selectedAccount?.balance : null"
              placeholder="0.00"
              (input)="validateTransactionAmount()">
            <div class="balance-info" *ngIf="transactionType === 'withdrawal' && selectedAccount">
              <small class="balance-text">
                üí∞ Saldo disponible: <strong>${{ selectedAccount.balance.toFixed(2) }}</strong>
              </small>
              <small class="warning-text" *ngIf="transactionAmount > selectedAccount.balance">
                ‚ö†Ô∏è El monto excede el saldo disponible
              </small>
            </div>
          </div>
          
          <div class="form-group">
            <label for="concept">Concepto:</label>
            <input 
              type="text" 
              id="concept" 
              [(ngModel)]="transactionConcept" 
              placeholder="Descripci√≥n del movimiento">
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeTransactionModal()">Cancelar</button>
        <button class="confirm-btn" (click)="processTransaction()">
          {{ transactionType === 'deposit' ? 'Depositar' : 'Retirar' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Movimientos de Tarjeta -->
  <div class="movements-modal" *ngIf="showMovementsModal" (click)="closeMovementsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h4>üí≥ Historial de Movimientos</h4>
        <button class="close-btn" (click)="closeMovementsModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="account-summary">
          <div class="account-info">
            <span class="account-name">{{ selectedAccount?.userName }}</span>
            <span class="account-number">{{ selectedAccount?.accountNumber }}</span>
          </div>
          <div class="current-balance">
            <span class="balance-amount">${{ selectedAccount?.balance?.toFixed(2) }}</span>
          </div>
        </div>

        <div class="filter-section">
          <label for="movementFilter">Filtrar por tipo:</label>
          <select id="movementFilter" [(ngModel)]="movementFilter" (change)="onMovementFilterChange()">
            <option value="all">Todos los movimientos</option>
            <option value="deposit">Solo dep√≥sitos</option>
            <option value="withdrawal">Solo retiros</option>
          </select>
        </div>

        <div class="movements-list" *ngIf="filteredMovements.length > 0">
          <div class="movement-item" *ngFor="let movement of filteredMovements" [class]="getMovementClass(movement.type)">
            <div class="movement-content">
              <div class="movement-info">
                <span class="movement-concept">{{ movement.concept }}</span>
                <span class="movement-date">{{ movement.createdAt?.toDate() | date:'dd/MM/yyyy HH:mm' }}</span>
                <span class="movement-user" *ngIf="movement.createdBy">Por: {{ getUserName(movement.createdBy) }}</span>
              </div>
              <span class="movement-amount" [class]="movement.type">
                {{ movement.type === 'deposit' ? '+' : '-' }}${{ movement.amount.toFixed(2) }}
              </span>
            </div>
          </div>
        </div>

        <div class="no-movements" *ngIf="filteredMovements.length === 0 && cardMovements.length > 0">
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <h4>No hay movimientos de este tipo</h4>
            <p>Cambia el filtro para ver otros movimientos</p>
          </div>
        </div>

        <div class="no-movements" *ngIf="cardMovements.length === 0">
          <div class="empty-state">
            <div class="empty-icon">üí≥</div>
            <h4>Sin movimientos</h4>
            <p>A√∫n no hay transacciones en esta cuenta</p>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="close-btn-footer" (click)="closeMovementsModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>